<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Virtual Labs</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>
  <body>
    <!-- sidebar and body -->
    <div class="flex min-h-[80vh]">
      <div class="px-6 pb-6 flex-1">
        <div class="flex flex-shrink-0">
          <div class="relative w-[700px] py-2">
            <div
              class="absolute bg-[#ff0000] h-[154px] w-2 rounded-md top-[125px] left-[300px]"
            ></div>
            <div
              class="z-10 absolute bg-[#ff0000] h-2 w-[44px] rounded-md top-[122px] left-[264px]"
            ></div>
            <div
              class="z-10 absolute bg-[#ff0000] h-2 w-[68px] rounded-md top-[272px] left-[300px]"
            ></div>
            <div
              class="z-10 absolute bg-[#0000ff] h-2 w-[49px] rounded-md top-[166px] right-[5px]"
            >
              <p class="pt-1 text-sm text-end font-medium">Msg out</p>
            </div>
            <div
              class="z-10 absolute bg-[#ffff00] h-2 w-[100px] rounded-md top-[272px] right-[144px]"
            ></div>
            <div
              class="z-10 absolute bg-black h-2 w-[60px] rounded-md top-[76px] left-[120px]"
            ></div>
            <div
              class="z-10 absolute bg-black h-2 w-[60px] rounded-md top-[122px] left-[120px]"
            >
              <p class="pt-1 text-sm absolute -top-[10px] -left-16 font-medium">
                FM Input
              </p>
            </div>
            <div class="absolute top-[150px] left-0">
              <p class="font-medium text-center my-2 text-[24px]">AM Signal</p>
              <div>
                <!-- message frequency -->
                <div class="flex flex-col mb-2 items-center">
                  <p class="text-[13px] pb-1 text-center font-bold">
                    Message Frequency
                  </p>
                  <input
                    id="messageFrequency"
                    value="1"
                    type="range"
                    min="1"
                    max="10000"
                    onchange="handleMessageFrequencyChange()"
                  />
                  <div class="leading-none messageFrequencyDiv">1</div>
                </div>
                <!-- carrier frequency -->
                <div class="flex flex-col items-center">
                  <p class="text-[13px] pb-1 font-bold">Carrier Frequency:</p>
                  <input
                    id="carrierFrequency"
                    value="10"
                    type="range"
                    min="1"
                    max="10000"
                    onchange="handleCarrierFrequencyChange()"
                  />
                  <div class="leading-none carrierFrequencyDiv">10</div>
                </div>
                <!--  -->
              </div>
            </div>
            <div class="flex justify-end p-8 gap-12">
              <!-- utilities -->
              <div
                class="relative bg-[#a9a9a9] p-1 pt-0 border-4 shadow-[5px_5px_5px_5px_rgba(0,0,0,0.6)] border-black w-[140px] h-[270px]"
              >
                <h5 class="text-center text-sm font-medium">UTILITIES</h5>
                <div class="flex justify-between px-1 pt-1">
                  <div class="flex flex-col items-center">
                    <div
                      class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                    ></div>
                    <p class="text-[12px] font-medium">REF</p>
                  </div>
                  <div
                    class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                  ></div>
                </div>
                <div class="flex justify-between px-1 pt-1">
                  <div
                    class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                  ></div>
                  <div
                    class="h-[24px] w-[24px] border-[5px] border-[#ff0000] bg-black rounded-full"
                  ></div>
                </div>
                <p
                  class="text-sm text-center border-b border-black font-medium"
                >
                  COMPARATOR
                </p>
                <div class="flex justify-between px-1 pt-1">
                  <div
                    class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                  ></div>
                  <div
                    class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                  ></div>
                </div>
                <p
                  class="text-sm text-center border-b border-black font-medium"
                >
                  RECTIFIER
                </p>

                <div class="flex justify-between px-1 pt-1">
                  <div
                    class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                  ></div>
                  <div
                    class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                  ></div>
                </div>
                <p
                  class="text-sm text-center border-b border-black font-medium"
                >
                  DIODE + LPF
                </p>

                <div class="flex justify-between px-1 pt-1">
                  <div
                    class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                  ></div>
                  <div
                    class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                  ></div>
                </div>
                <p
                  class="text-sm text-center border-b border-black font-medium"
                >
                  RC LPF
                </p>
              </div>
              <!-- TWIN PULSE GENERATOR -->
              <div
                class="relative bg-[#a9a9a9] p-1 pt-0 border-4 shadow-[5px_5px_5px_5px_rgba(0,0,0,0.6)] border-black w-[140px] h-[270px]"
              >
                <h5 class="text-center text-sm font-medium">
                  TWIN PULSE GENERATOR
                </h5>
                <div class="flex mt-1 flex-col items-end">
                  <div class="flex flex-col items-end">
                    <div
                      class="h-[20px] w-[20px] border-[5px] border-[#3a3939] shadow-md bg-[#5c1414] rounded-full"
                    ></div>
                    <p class="text-[12px] font-medium">ERROR</p>
                  </div>
                </div>
                <div
                  class="flex absolute right-0 top-[120px] flex-col items-end"
                >
                  <div class="flex flex-col items-end mr-1">
                    <div
                      class="h-[22px] w-[22px] border-[5px] border-[#ff0000] bg-black rounded-full"
                    ></div>
                    <p class="text-[12px] font-medium">Q2</p>
                  </div>
                </div>
                <div class="flex flex-col items-center justify-center gap-8">
                  <div class="flex flex-col items-center">
                    <div
                      class="h-[26px] w-[26px] border-[4px] relative shadow-black shadow-lg border-black bg-[#ffff00] rounded-full"
                    >
                      <div
                        class="w-1 h-2 absolute top-[50%] left-[40%] bg-black"
                      ></div>
                    </div>
                    <p class="text-[12px] font-medium">WIDTH</p>
                  </div>
                  <div class="flex flex-col items-center">
                    <div
                      class="h-[26px] w-[26px] relative border-[4px] shadow-black shadow-md border-black bg-[#ffff00] rounded-full"
                    >
                      <div
                        class="w-1 h-2 absolute top-[50%] left-[40%] bg-black"
                      ></div>
                    </div>
                    <p class="text-[12px] font-medium">DELAY</p>
                  </div>
                </div>
                <!--  -->
                <div
                  class="flex items-center justify-between px-2 gap-8 absolute bottom-0 w-full"
                >
                  <div class="flex flex-col items-start">
                    <div
                      class="h-[24px] w-[24px] border-[5px] border-[#ff0000] bg-black rounded-full"
                    ></div>
                    <p class="text-[12px] font-medium">CLK</p>
                  </div>
                  <div class="flex flex-col items-start">
                    <div
                      class="h-[24px] w-[24px] border-[5px] border-[#ff0000] bg-black rounded-full"
                    ></div>
                    <p class="text-[12px] font-medium">Q1</p>
                  </div>
                </div>
              </div>
              <!-- HEADPHONE AMPLIFIER -->
              <div
                class="relative bg-[#a9a9a9] p-1 pt-0 border-4 shadow-[5px_5px_5px_5px_rgba(0,0,0,0.6)] border-black w-[140px] h-[270px]"
              >
                <h5 class="text-center text-sm font-medium">
                  HEADPHONE AMPLIFIER
                </h5>
                <p class="text-center text-[12px] pt-2 font-medium">
                  LPF SELECT
                </p>
                <div class="flex justify-center mt-2 gap-2 items-center">
                  <p class="text-[12px] font-medium">IN</p>
                  <div
                    class="relative h-[24px] w-[24px] border-[5px] border-[#464644] bg-black rounded-full"
                  >
                    <span
                      class="absolute top-[4px] rounded-md -left-2 w-4 h-[5px] bg-white"
                    ></span>
                  </div>
                  <p class="text-[12px] font-medium">OUT</p>
                </div>
                <div class="flex mt-4 flex-col items-end">
                  <div class="flex flex-col items-start">
                    <div
                      class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                    ></div>
                    <p class="text-[12px] font-medium">LPF</p>
                  </div>
                </div>
                <div class="flex flex-col items-center justify-center gap-3">
                  <div class="flex flex-col items-center">
                    <div
                      class="h-[26px] w-[26px] border-[4px] relative shadow-black shadow-lg border-black bg-[#ffff00] rounded-full"
                    >
                      <div
                        class="w-1 h-2 absolute top-[50%] left-[40%] bg-black"
                      ></div>
                    </div>
                    <p class="text-[12px] font-medium">K</p>
                  </div>
                </div>
                <!--  -->
                <div
                  class="flex items-center justify-between px-2 gap-8 absolute bottom-0 w-full"
                >
                  <div class="flex flex-col items-center">
                    <div
                      class="h-[24px] w-[24px] border-[5px] border-[#ffff00] bg-black rounded-full"
                    ></div>
                    <p class="text-[12px] font-medium">A</p>
                  </div>
                  <div class="flex flex-col items-center">
                    <div
                      class="h-[24px] w-[24px] border-[5px] border-[#575749] bg-black rounded-full"
                    ></div>
                    <p class="text-[12px] font-medium">KA</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="flex flex-col items-center">
            <div class="w-full my-3">
              <div class="flex justify-between m-2">
                <div class="flex flex-1 items-center gap-3">
                  <p class="font-medium">Cut-off Frequency:</p>
                  <input
                    class="border px-1 w-[152px] py-1 rounded-sm border-black"
                    type="number"
                    id="cutoffFrequency"
                    value="1"
                  />
                  <button
                    class="bg-blue-500 text-white py-1 px-3 rounded-md hover:scale-105"
                    onclick="createPlots()"
                  >
                    Generate
                  </button>
                </div>
              </div>
            </div>
            <div class="plotSection">
              <div class="w-[600px] h-[450px]">
                <div id="plots" class="w-[100%] h-[100%]"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
    function handleMessageFrequencyChange() {
        const messageValue = parseFloat(
          document.getElementById("messageFrequency").value
        );
        document.querySelector(".messageFrequencyDiv").innerHTML = messageValue;
      }
      function handleCarrierFrequencyChange() {
        const messageValue = parseFloat(
          document.getElementById("carrierFrequency").value
        );
        document.querySelector(".carrierFrequencyDiv").innerHTML = messageValue;
      }
      // JavaScript code for frequency demodulation
      function frequencyDemodulation(
        messageFrequency,
        carrierFrequency,
        cutoffFrequency
      ) {
        const kf = 50;
        const fs = carrierFrequency * 10;
        const numPoints = 10000;
        //const xValues = Array.from({ length: numPoints }, (_, i) => i * (5 / (messageFrequency * numPoints)));
        const xValues = Array.from(
          { length: numPoints },
          (_, i) => i * (5 / (messageFrequency * numPoints))
        );
        const messageSignal = xValues.map((t) =>
          Math.sin(2 * Math.PI * messageFrequency * t)
        );

        const modulatedSignal = xValues.map((t, i) =>
          Math.cos(
            2 * Math.PI * carrierFrequency * t +
              (kf * (i === 0 ? 0 : simpson(messageSignal.slice(0, i)))) / fs
          )
        );

        const instantaneousPhase = unwrap(angle(hilbert(modulatedSignal)));
        const demodulatedSignal1 = diff(instantaneousPhase).map(
          (diffValue) => (diffValue * fs) / (2 * Math.PI * kf)
        );

        // Apply low-pass filter
        const demodulatedSignal = lowPassFilter(
          demodulatedSignal1,
          cutoffFrequency,
          fs
        );

        return {
          x: xValues,
          y: demodulatedSignal,
          messageSignal: messageSignal,
          modulatedSignal: modulatedSignal,
        };
      }

      // Function to compute the cumulative sum (Simpson's rule approximation)
      function simpson(arr) {
        let sum = 0;
        for (let i = 0; i < arr.length; i++) {
          sum += arr[i];
        }
        return sum;
      }

      // Function to compute the phase angle of a complex array
      function angle(arr) {
        return arr.map((value) => Math.atan2(value.im, value.re));
      }

      // Function to compute the Hilbert transform of a real-valued signal
      function hilbert(arr) {
        return arr.map((value) => ({ re: value, im: 0 }));
      }

      // Function to unwrap phase angles
      function unwrap(arr) {
        const unwrapped = [];
        unwrapped.push(arr[0]);
        for (let i = 1; i < arr.length; i++) {
          let diff = arr[i] - arr[i - 1];
          if (diff > Math.PI) {
            diff -= 2 * Math.PI;
          } else if (diff < -Math.PI) {
            diff += 2 * Math.PI;
          }
          unwrapped.push(unwrapped[i - 1] + diff);
        }
        return unwrapped;
      }

      // Function to compute the difference of an array
      function diff(arr) {
        const result = [];
        for (let i = 1; i < arr.length; i++) {
          result.push(arr[i] - arr[i - 1]);
        }
        return result;
      }

      // Low-pass filter function using a moving average
      function lowPassFilter(signal, cutoffFrequency, sampleRate) {
        const filteredSignal = [];
        const RC = 1.0 / (cutoffFrequency * 2 * Math.PI);
        const dt = 1.0 / sampleRate;
        const alpha = dt / (RC + dt);
        let yPrev = 0;
        for (let i = 0; i < signal.length; i++) {
          const input = signal[i];
          const output = alpha * input + (1 - alpha) * yPrev;
          filteredSignal.push(output);
          yPrev = output;
        }
        return filteredSignal;
      }

      // Function to create plots
      function createPlots() {
        var messageFrequency = parseFloat(
          document.getElementById("messageFrequency").value
        );
        var carrierFrequency = parseFloat(
          document.getElementById("carrierFrequency").value
        );
        var cutoffFrequency = parseFloat(
          document.getElementById("cutoffFrequency").value
        );

        var data = frequencyDemodulation(
          messageFrequency,
          carrierFrequency,
          cutoffFrequency
        );

        // Plot demodulated signal
        var demodulatedPlotDiv = document.createElement("div");
        Plotly.newPlot(
          demodulatedPlotDiv,
          [
            {
              x: data.x,
              y: data.y,
              mode: "lines",
              name: "Demodulated Signal",
              line: { color: "blue" },
            },
          ],
          {
            title: "Demodulated Signal",
            width:600,
            height:450,
            xaxis: {
              title: "Time",
            },
            yaxis: {
              title: "Amplitude",
            },
          }
        );
        document.getElementById("plots").innerHTML = ""; // Clear previous plots
        document.getElementById("plots").appendChild(demodulatedPlotDiv);

        // Plot modulated signal
        var modulatedPlotDiv = document.createElement("div");
        Plotly.newPlot(
          modulatedPlotDiv,
          [
            {
              x: data.x,
              y: data.modulatedSignal,
              mode: "lines",
              name: "Modulated Signal",
              line: { color: "red" },
            },
          ],
          {
            title: "Modulated Signal",
            width:600,
            height:450,
            xaxis: {
              title: "Time",
            },
            yaxis: {
              title: "Amplitude",
            },
          }
        );
        document.getElementById("plots").appendChild(modulatedPlotDiv);

        // Plot message signal
        var messagePlotDiv = document.createElement("div");
        Plotly.newPlot(
          messagePlotDiv,
          [
            {
              x: data.x,
              y: data.messageSignal,
              mode: "lines",
              name: "Message Signal",
              line: { color: "green" },
            },
          ],
          {
            title: "Message Signal",
            width:600,
            height:450,
            xaxis: {
              title: "Time",
            },
            yaxis: {
              title: "Amplitude",
            },
          }
        );
        document.getElementById("plots").appendChild(messagePlotDiv);
      }

      // Add event listeners to input fields to trigger plot generation on change
      document
        .getElementById("messageFrequency")
        .addEventListener("change", createPlots);
      document
        .getElementById("carrierFrequency")
        .addEventListener("change", createPlots);
      document
        .getElementById("cutoffFrequency")
        .addEventListener("change", createPlots);
    </script>
  </body>
</html>
